{% extends "base.html" %}

{% include 'properties/lotes/_assign_client_modal.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <form id="filterForm" method="GET" action="{{ url_for('properties.lotes_public') }}">
                {{ form.csrf_token }}
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label" for="fraccionamiento">Fraccionamiento</label>
                        {{ form.fraccionamiento(class="form-select") }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="paquete">Paquete</label>
                        {{ form.paquete(class="form-select") }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="estado">Estado</label>
                        {{ form.estado(class="form-select") }}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h1 class="my-4">Lotes Disponibles</h1>
            
            {% if lotes %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Manzana</th>
                        <th>Lote</th>
                        <th>Prototipo</th>
                        <th>Terreno</th>
                        <th>Precio</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lote in lotes %}
                    <tr>
                        <td>{{ lote.id }}</td>
                        <td>{{ lote.manzana }}</td>
                        <td>{{ lote.lote }}</td>
                        <td>{{ lote.prototipo.nombre_prototipo if lote.prototipo else 'N/A' }}</td>
                        <td>{{ lote.terreno }} mÂ²</td>
                        <td>${{ "{:,.2f}".format(lote.precio) }}</td>
                        <td>
                            {% if lote.estado_del_inmueble == 'Libre' %}
                                <span class="badge bg-success">{{ lote.estado_del_inmueble }}</span>
                            {% elif lote.estado_del_inmueble == 'Apartado' %}
                                <span class="badge bg-warning">{{ lote.estado_del_inmueble }}</span>
                            {% elif lote.estado_del_inmueble == 'Titulado' %}
                                <span class="badge bg-danger">{{ lote.estado_del_inmueble }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ lote.estado_del_inmueble }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                {% if lote.estado_del_inmueble == 'Libre' %}
                                <button type="button" class="btn btn-primary assign-client-btn" 
                                        data-lote-id="{{ lote.id }}" title="Asignar Cliente">
                                    <i class="fas fa-user-plus"></i> Asignar Cliente
                                </button>
                                {% endif %}
                                <button class="btn btn-info lot-details-trigger" data-lote-id="{{ lote.id }}">
                                    <i class="fas fa-info-circle"></i> Detalles
                                </button>
                                <button class="btn btn-warning lot-status-change-trigger" 
                                        data-lote-id="{{ lote.id }}" 
                                        data-current-status="{{ lote.estado_del_inmueble }}">
                                    <i class="fas fa-exchange-alt"></i> Cambiar Estado
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="alert alert-info">
                No se encontraron lotes disponibles con los filtros seleccionados.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/lotes.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Populate paquete dropdown based on selected fraccionamiento
    const fraccionamientoSelect = document.getElementById('fraccionamiento');
    const paqueteSelect = document.getElementById('paquete');

    fraccionamientoSelect.addEventListener('change', function() {
        const selectedFraccionamiento = this.value;
        
        // Reset paquete dropdown
        paqueteSelect.innerHTML = '<option value="">Seleccionar Paquete</option>';
        
        // If a fraccionamiento is selected, fetch its paquetes
        if (selectedFraccionamiento) {
            fetch(`/properties/paquetes/${selectedFraccionamiento}`)
                .then(response => response.json())
                .then(paquetes => {
                    paquetes.forEach(paquete => {
                        const option = document.createElement('option');
                        option.value = paquete.id;
                        option.textContent = paquete.nombre;
                        paqueteSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching paquetes:', error);
                });
        }
    });
});
</script>
{% endblock %}
